---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { TermsContentManager } from "@/lib/terms/content";

// Get the current terms content
const termsContent = TermsContentManager.getCurrentContent();
const sectionsInOrder = TermsContentManager.getSectionsInOrder();
const summary = TermsContentManager.generateSummary();

// Format the last updated date for display
const lastUpdatedFormatted = termsContent.lastUpdated.toLocaleDateString(
  "pt-BR",
  {
    year: "numeric",
    month: "long",
    day: "numeric",
  },
);

// Format the effective date
const effectiveDateFormatted =
  termsContent.metadata.effectiveDate.toLocaleDateString("pt-BR", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
---

<BaseLayout title="Termos de Servi√ßo">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Skip to content link for screen readers -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-primary-foreground px-4 py-2 rounded-md z-50 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
    >
      Pular para o conte√∫do principal
    </a>

    <!-- Header Section -->
    <header class="mb-8 sm:mb-12">
      <h1
        class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-4 sm:mb-6 text-primary"
      >
        Termos de Servi√ßo
      </h1>

      <!-- Version and Date Information -->
      <div class="bg-secondary p-4 sm:p-6 rounded-lg shadow-md mb-6 sm:mb-8">
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 text-sm"
        >
          <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="font-semibold text-muted-foreground mb-1 sm:mb-0"
              >Vers√£o:</span
            >
            <span
              class="sm:ml-2 font-mono bg-primary/10 px-2 py-1 rounded text-xs sm:text-sm w-fit"
              >{summary.version}</span
            >
          </div>
          <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="font-semibold text-muted-foreground mb-1 sm:mb-0"
              >√öltima Atualiza√ß√£o:</span
            >
            <span class="sm:ml-2 text-xs sm:text-sm"
              >{lastUpdatedFormatted}</span
            >
          </div>
          <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="font-semibold text-muted-foreground mb-1 sm:mb-0"
              >Data Efetiva:</span
            >
            <span class="sm:ml-2 text-xs sm:text-sm"
              >{effectiveDateFormatted}</span
            >
          </div>
        </div>
      </div>

      <!-- Table of Contents -->
      <nav
        class="bg-background border border-border rounded-lg p-4 sm:p-6 mb-6 sm:mb-8"
        aria-label="√çndice dos Termos de Servi√ßo"
        role="navigation"
      >
        <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4">√çndice</h2>
        <ol class="space-y-1 sm:space-y-2" role="list">
          {
            sectionsInOrder.map((section, index) => (
              <li role="listitem">
                <a
                  href={`#section-${section.id}`}
                  class="text-primary hover:text-primary/80 focus:text-primary/80 transition-colors duration-200 flex items-center text-sm sm:text-base py-1 px-2 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                  aria-describedby={`toc-item-${index}`}
                >
                  <span class="mr-2 text-muted-foreground" aria-hidden="true">
                    ‚Ä¢
                  </span>
                  <span class="break-words">{section.title}</span>
                </a>
              </li>
            ))
          }
        </ol>
      </nav>
    </header>

    <!-- Terms Content -->
    <main class="space-y-8 sm:space-y-12" id="main-content" tabindex="-1">
      {
        sectionsInOrder.map((section) => (
          <section
            id={`section-${section.id}`}
            class="scroll-mt-16 sm:scroll-mt-8"
            aria-labelledby={`heading-${section.id}`}
          >
            <h2
              id={`heading-${section.id}`}
              class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-primary border-b border-border pb-2 focus:outline-none"
              tabindex="-1"
            >
              {section.title}
            </h2>

            <div class="prose prose-sm sm:prose-lg max-w-none">
              <div
                class="text-muted-foreground leading-relaxed whitespace-pre-line text-sm sm:text-base"
                set:html={section.content.replace(/\n/g, "<br>")}
              />
            </div>

            {section.lastModified && (
              <div class="mt-3 sm:mt-4 text-xs text-muted-foreground bg-muted/30 px-3 py-2 rounded-md">
                <span class="font-medium">√öltima modifica√ß√£o:</span>{" "}
                {section.lastModified.toLocaleDateString("pt-BR")}
              </div>
            )}
          </section>
        ))
      }
    </main>

    <!-- Footer Information -->
    <footer class="mt-12 sm:mt-16 pt-6 sm:pt-8 border-t border-border">
      <div class="bg-secondary p-4 sm:p-6 rounded-lg">
        <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">
          Informa√ß√µes Importantes
        </h3>

        <div class="space-y-3 sm:space-y-4 text-sm text-muted-foreground">
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"
          >
            <p>
              <strong class="text-foreground">Jurisdi√ß√£o:</strong>
              <span class="block sm:inline sm:ml-1"
                >{termsContent.metadata.jurisdiction}</span
              >
            </p>
            <p>
              <strong class="text-foreground">Idioma:</strong>
              <span class="block sm:inline sm:ml-1">
                {
                  termsContent.metadata.language === "pt-BR"
                    ? "Portugu√™s (Brasil)"
                    : termsContent.metadata.language
                }
              </span>
            </p>
            <p>
              <strong class="text-foreground">Total de Se√ß√µes:</strong>
              <span class="block sm:inline sm:ml-1">{summary.sectionCount}</span
              >
            </p>
          </div>

          <div
            class="mt-4 sm:mt-6 p-3 sm:p-4 bg-primary/5 border border-primary/20 rounded-lg"
            role="note"
            aria-label="Aviso importante sobre os termos"
          >
            <p class="text-primary font-medium mb-2 flex items-center">
              <span class="mr-2" aria-hidden="true">üìã</span>
              <span>Importante</span>
            </p>
            <p class="text-xs sm:text-sm leading-relaxed">
              Ao continuar usando nosso servi√ßo, voc√™ confirma ter lido,
              compreendido e concordado com estes termos. Se voc√™ n√£o concorda
              com qualquer parte destes termos, deve interromper o uso do
              servi√ßo imediatamente.
            </p>
          </div>
        </div>
      </div>

      <!-- Navigation Links -->
      <nav
        class="mt-6 sm:mt-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 sm:gap-6"
        aria-label="Navega√ß√£o do rodap√©"
      >
        <a
          href="/"
          class="inline-flex items-center text-primary hover:text-primary/80 focus:text-primary/80 transition-colors duration-200 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          aria-label="Voltar para a p√°gina inicial"
        >
          <svg
            class="w-4 h-4 mr-2 flex-shrink-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
          <span>Voltar para P√°gina Inicial</span>
        </a>

        <div class="flex flex-wrap gap-2 sm:gap-4 text-sm">
          <a
            href="/privacy"
            class="text-muted-foreground hover:text-primary focus:text-primary transition-colors duration-200 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
            aria-label="Acessar Pol√≠tica de Privacidade"
          >
            Pol√≠tica de Privacidade
          </a>
          <span class="text-muted-foreground select-none" aria-hidden="true"
            >|</span
          >
          <a
            href="/about"
            class="text-muted-foreground hover:text-primary focus:text-primary transition-colors duration-200 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
            aria-label="Sobre o simulador"
          >
            Sobre
          </a>
          <span class="text-muted-foreground select-none" aria-hidden="true"
            >|</span
          >
          <a
            href="mailto:suporte@simuladoraws.com.br"
            class="text-muted-foreground hover:text-primary focus:text-primary transition-colors duration-200 px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
            aria-label="Entrar em contato por email"
          >
            Contato
          </a>
        </div>
      </nav>
    </footer>
  </div>

  <!-- Enhanced Styles for Accessibility and Responsiveness -->
  <style>
    /* Print Styles */
    @media print {
      .no-print {
        display: none !important;
      }

      body {
        font-size: 12pt;
        line-height: 1.4;
        color: black !important;
      }

      h1 {
        font-size: 18pt;
        margin-bottom: 12pt;
        color: black !important;
      }

      h2 {
        font-size: 14pt;
        margin-top: 12pt;
        margin-bottom: 6pt;
        page-break-after: avoid;
        color: black !important;
      }

      section {
        page-break-inside: avoid;
        margin-bottom: 12pt;
      }

      .bg-secondary,
      .bg-background {
        background: white !important;
        border: 1px solid #ccc !important;
      }

      /* Hide interactive elements in print */
      button,
      .focus\:ring-2 {
        display: none !important;
      }
    }

    /* Smooth scrolling for anchor links */
    html {
      scroll-behavior: smooth;
    }

    /* Reduced motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      html {
        scroll-behavior: auto;
      }

      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .text-muted-foreground {
        color: hsl(var(--foreground)) !important;
      }

      .border-border {
        border-color: hsl(var(--foreground)) !important;
      }
    }

    /* Enhanced focus styles for accessibility */
    a:focus-visible,
    button:focus-visible {
      outline: 2px solid hsl(var(--primary));
      outline-offset: 2px;
      border-radius: 4px;
    }

    /* Skip link styles */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .sr-only:focus,
    .focus\:not-sr-only:focus {
      position: static;
      width: auto;
      height: auto;
      padding: 0.5rem 1rem;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
    }

    /* Enhanced readability */
    .prose {
      line-height: 1.7;
    }

    /* Responsive typography with better scaling */
    @media (max-width: 640px) {
      h1 {
        font-size: 1.75rem;
        line-height: 1.2;
      }

      h2 {
        font-size: 1.375rem;
        line-height: 1.3;
      }

      .prose {
        font-size: 0.875rem;
        line-height: 1.6;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }

      h2 {
        font-size: 1.25rem;
      }

      .prose {
        font-size: 0.8125rem;
      }
    }

    /* Better touch targets for mobile */
    @media (max-width: 768px) {
      a,
      button {
        min-height: 44px;
        min-width: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* Dark mode enhancements */
    @media (prefers-color-scheme: dark) {
      .bg-primary\/5 {
        background-color: hsl(var(--primary) / 0.1) !important;
      }
    }

    /* Focus management for sections */
    section:focus {
      outline: none;
    }

    section:target {
      animation: highlight 2s ease-in-out;
    }

    @keyframes highlight {
      0% {
        background-color: hsl(var(--primary) / 0.1);
      }
      100% {
        background-color: transparent;
      }
    }

    /* Ensure proper contrast for separators */
    [role="separator"] {
      opacity: 0.6;
    }

    /* Better spacing for mobile navigation */
    @media (max-width: 640px) {
      nav[aria-label="Navega√ß√£o do rodap√©"] {
        align-items: stretch;
      }

      nav[aria-label="Navega√ß√£o do rodap√©"] > div {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      nav[aria-label="Navega√ß√£o do rodap√©"] [aria-hidden="true"] {
        display: none;
      }
    }
  </style>

  <!-- Enhanced Accessibility and Interaction Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Enhanced keyboard navigation for table of contents
      const tocLinks = document.querySelectorAll(
        'nav[aria-label="√çndice dos Termos de Servi√ßo"] a',
      );

      tocLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          const targetId = this.getAttribute("href");
          const targetElement = document.querySelector(targetId);

          if (targetElement) {
            // Smooth scroll with reduced motion support
            const prefersReducedMotion = window.matchMedia(
              "(prefers-reduced-motion: reduce)",
            ).matches;

            targetElement.scrollIntoView({
              behavior: prefersReducedMotion ? "auto" : "smooth",
              block: "start",
            });

            // Set focus for screen readers and keyboard users
            targetElement.setAttribute("tabindex", "-1");
            targetElement.focus();

            // Announce to screen readers
            const announcement = document.createElement("div");
            announcement.setAttribute("aria-live", "polite");
            announcement.setAttribute("aria-atomic", "true");
            announcement.className = "sr-only";
            announcement.textContent = `Navegou para a se√ß√£o: ${targetElement.querySelector("h2").textContent}`;
            document.body.appendChild(announcement);

            // Clean up announcement after screen reader has time to read it
            setTimeout(() => {
              document.body.removeChild(announcement);
            }, 1000);
          }
        });

        // Enhanced keyboard support
        link.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            this.click();
          }
        });
      });

      // Add responsive print functionality
      const printButton = document.createElement("button");
      printButton.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        <span class="hidden sm:inline">Imprimir</span>
        <span class="sm:hidden">üñ®Ô∏è</span>
      `;
      printButton.className =
        "fixed bottom-4 right-4 bg-primary text-primary-foreground px-3 py-2 sm:px-4 sm:py-2 rounded-lg shadow-lg hover:bg-primary/90 focus:bg-primary/90 transition-colors no-print focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 flex items-center text-sm";
      printButton.setAttribute(
        "aria-label",
        "Imprimir p√°gina dos termos de servi√ßo",
      );
      printButton.onclick = () => window.print();
      document.body.appendChild(printButton);

      // Add keyboard shortcut for print (Ctrl+P)
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.key === "p") {
          e.preventDefault();
          window.print();
        }
      });

      // Enhance focus management for skip links
      const skipLink = document.querySelector('a[href="#main-content"]');
      if (skipLink) {
        skipLink.addEventListener("click", function (e) {
          e.preventDefault();
          const mainContent = document.querySelector("#main-content");
          if (mainContent) {
            mainContent.focus();
            mainContent.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      }

      // Add high contrast mode detection and enhancement
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-contrast: high)").matches
      ) {
        document.body.classList.add("high-contrast");
      }

      // Monitor for contrast preference changes
      if (window.matchMedia) {
        const contrastQuery = window.matchMedia("(prefers-contrast: high)");
        contrastQuery.addEventListener("change", function (e) {
          if (e.matches) {
            document.body.classList.add("high-contrast");
          } else {
            document.body.classList.remove("high-contrast");
          }
        });
      }

      // Add resize handler for responsive adjustments
      let resizeTimeout;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          // Adjust print button position on mobile
          const printBtn = document.querySelector(".fixed.bottom-4.right-4");
          if (printBtn && window.innerWidth < 640) {
            printBtn.style.bottom = "1rem";
            printBtn.style.right = "1rem";
          }
        }, 250);
      });

      // Announce page load completion to screen readers
      const loadAnnouncement = document.createElement("div");
      loadAnnouncement.setAttribute("aria-live", "polite");
      loadAnnouncement.className = "sr-only";
      loadAnnouncement.textContent =
        "P√°gina dos Termos de Servi√ßo carregada completamente";
      document.body.appendChild(loadAnnouncement);

      setTimeout(() => {
        document.body.removeChild(loadAnnouncement);
      }, 2000);
    });
  </script>
</BaseLayout>
